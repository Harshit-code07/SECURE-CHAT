<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureChat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: sans-serif; height: 100vh; overflow: hidden; }
        .glass-box { background: #0f172a; border: 2px solid #334155; border-radius: 1.5rem; }
        .manual-code-area { background: #000000 !important; color: #ffffff !important; border: 2px solid #475569 !important; font-weight: bold; }
        .msg-me { background: #059669; color: white; border-radius: 1rem 1rem 0 1rem; align-self: flex-end; }
        .msg-them { background: #1e293b; color: white; border-radius: 1rem 1rem 1rem 0; align-self: flex-start; }
        .qr-frame { background: white; padding: 10px; border-radius: 8px; border: 4px solid #10b981; }
        #status { background: #1e293b; color: #ffffff; padding: 4px 12px; border-radius: 9999px; font-weight: 900; border: 1px solid #475569; }
        input[type="text"] { color: white !important; background-color: #000000 !important; opacity: 1 !important; }
        .modal-overlay { background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
        
        /* Chat Layout Helpers */
        .chat-scroll-area { height: calc(100vh - 280px); overflow-y: auto; scroll-behavior: smooth; }
        
        /* File sharing styles */
        .msg-file { background: #7c3aed; color: white; border-radius: 1rem; padding: 12px; margin: 8px 0; cursor: pointer; transition: all 0.2s; max-width: 85%; }
        .msg-file:hover { background: #6d28d9; }
    </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{inset:0px}.right-4{right:1rem}.top-4{top:1rem}.z-50{z-index:50}.my-4{margin-top:1rem;margin-bottom:1rem}.mb-4{margin-bottom:1rem}.ml-1{margin-left:0.25rem}.mt-4{margin-top:1rem}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-20{height:5rem}.h-24{height:6rem}.h-px{height:1px}.max-h-full{max-height:100%}.w-full{width:100%}.max-w-2xl{max-width:42rem}.max-w-sm{max-width:24rem}.max-w-xl{max-width:36rem}.flex-1{flex:1 1 0%}.shrink-0{flex-shrink:0}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.flex-col{flex-direction:column}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:0.5rem}.gap-3{gap:0.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-y-2 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.5rem * var(--tw-space-y-reverse))}.space-y-3 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.75rem * var(--tw-space-y-reverse))}.space-y-4 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.space-y-6 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem * var(--tw-space-y-reverse))}.space-y-8 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(2rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(2rem * var(--tw-space-y-reverse))}.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.rounded{border-radius:0.25rem}.rounded-3xl{border-radius:1.5rem}.rounded-lg{border-radius:0.5rem}.rounded-xl{border-radius:0.75rem}.border{border-width:1px}.border-2{border-width:2px}.border-b{border-bottom-width:1px}.border-b-4{border-bottom-width:4px}.border-t{border-top-width:1px}.border-emerald-900{--tw-border-opacity:1;border-color:rgb(6 78 59 / var(--tw-border-opacity, 1))}.border-red-500{--tw-border-opacity:1;border-color:rgb(239 68 68 / var(--tw-border-opacity, 1))}.border-slate-400{--tw-border-opacity:1;border-color:rgb(148 163 184 / var(--tw-border-opacity, 1))}.border-slate-600{--tw-border-opacity:1;border-color:rgb(71 85 105 / var(--tw-border-opacity, 1))}.border-slate-700{--tw-border-opacity:1;border-color:rgb(51 65 85 / var(--tw-border-opacity, 1))}.border-slate-800{--tw-border-opacity:1;border-color:rgb(30 41 59 / var(--tw-border-opacity, 1))}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0 / var(--tw-bg-opacity, 1))}.bg-black\/20{background-color:rgb(0 0 0 / 0.2)}.bg-black\/30{background-color:rgb(0 0 0 / 0.3)}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity, 1))}.bg-emerald-600{--tw-bg-opacity:1;background-color:rgb(5 150 105 / var(--tw-bg-opacity, 1))}.bg-red-600{--tw-bg-opacity:1;background-color:rgb(220 38 38 / var(--tw-bg-opacity, 1))}.bg-slate-700{--tw-bg-opacity:1;background-color:rgb(51 65 85 / var(--tw-bg-opacity, 1))}.bg-slate-800{--tw-bg-opacity:1;background-color:rgb(30 41 59 / var(--tw-bg-opacity, 1))}.bg-slate-900{--tw-bg-opacity:1;background-color:rgb(15 23 42 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.p-4{padding:1rem}.p-2{padding:0.5rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-5{padding-top:1.25rem;padding-bottom:1.25rem}.pt-6{padding-top:1.5rem}.text-center{text-align:center}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-5xl{font-size:3rem;line-height:1}.text-\[10px\]{font-size:10px}.text-\[9px\]{font-size:9px}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-black{font-weight:900}.font-bold{font-weight:700}.font-extrabold{font-weight:800}.uppercase{text-transform:uppercase}.italic{font-style:italic}.tracking-tighter{letter-spacing:-0.05em}.tracking-widest{letter-spacing:0.1em}.text-black{--tw-text-opacity:1;color:rgb(0 0 0 / var(--tw-text-opacity, 1))}.text-blue-400{--tw-text-opacity:1;color:rgb(96 165 250 / var(--tw-text-opacity, 1))}.text-emerald-400{--tw-text-opacity:1;color:rgb(52 211 153 / var(--tw-text-opacity, 1))}.text-emerald-500{--tw-text-opacity:1;color:rgb(16 185 129 / var(--tw-text-opacity, 1))}.text-red-500{--tw-text-opacity:1;color:rgb(239 68 68 / var(--tw-text-opacity, 1))}.text-slate-300{--tw-text-opacity:1;color:rgb(203 213 225 / var(--tw-text-opacity, 1))}.text-slate-400{--tw-text-opacity:1;color:rgb(148 163 184 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.underline{-webkit-text-decoration-line:underline;text-decoration-line:underline}.shadow-2xl{--tw-shadow:0 25px 50px -12px rgb(0 0 0 / 0.25);--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.outline-none{outline:2px solid transparent;outline-offset:2px}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-colors{transition-property:color, background-color, border-color, fill, stroke, -webkit-text-decoration-color;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, -webkit-text-decoration-color;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.hover\:border-red-500:hover{--tw-border-opacity:1;border-color:rgb(239 68 68 / var(--tw-border-opacity, 1))}.hover\:bg-red-900:hover{--tw-bg-opacity:1;background-color:rgb(127 29 29 / var(--tw-bg-opacity, 1))}.hover\:bg-slate-700:hover{--tw-bg-opacity:1;background-color:rgb(51 65 85 / var(--tw-bg-opacity, 1))}.focus\:border-emerald-500:focus{--tw-border-opacity:1;border-color:rgb(16 185 129 / var(--tw-border-opacity, 1))}.active\:translate-y-1:active{--tw-translate-y:0.25rem;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.active\:scale-90:active{--tw-scale-x:.9;--tw-scale-y:.9;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.active\:border-b-0:active{border-bottom-width:0px}@media (min-width: 640px){.sm\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}}</style><style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{inset:0px}.right-4{right:1rem}.top-4{top:1rem}.z-50{z-index:50}.my-4{margin-top:1rem;margin-bottom:1rem}.mb-4{margin-bottom:1rem}.ml-1{margin-left:0.25rem}.mt-2{margin-top:0.5rem}.mt-4{margin-top:1rem}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-20{height:5rem}.h-24{height:6rem}.h-6{height:1.5rem}.h-px{height:1px}.max-h-full{max-height:100%}.w-32{width:8rem}.w-6{width:1.5rem}.w-full{width:100%}.max-w-2xl{max-width:42rem}.max-w-sm{max-width:24rem}.max-w-xl{max-width:36rem}.flex-1{flex:1 1 0%}.shrink-0{flex-shrink:0}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.flex-col{flex-direction:column}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:0.5rem}.gap-3{gap:0.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-y-2 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.5rem * var(--tw-space-y-reverse))}.space-y-3 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.75rem * var(--tw-space-y-reverse))}.space-y-4 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.space-y-6 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem * var(--tw-space-y-reverse))}.space-y-8 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(2rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(2rem * var(--tw-space-y-reverse))}.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.rounded{border-radius:0.25rem}.rounded-3xl{border-radius:1.5rem}.rounded-lg{border-radius:0.5rem}.rounded-xl{border-radius:0.75rem}.border{border-width:1px}.border-2{border-width:2px}.border-b{border-bottom-width:1px}.border-b-4{border-bottom-width:4px}.border-t{border-top-width:1px}.border-emerald-900{--tw-border-opacity:1;border-color:rgb(6 78 59 / var(--tw-border-opacity, 1))}.border-red-500{--tw-border-opacity:1;border-color:rgb(239 68 68 / var(--tw-border-opacity, 1))}.border-slate-400{--tw-border-opacity:1;border-color:rgb(148 163 184 / var(--tw-border-opacity, 1))}.border-slate-600{--tw-border-opacity:1;border-color:rgb(71 85 105 / var(--tw-border-opacity, 1))}.border-slate-700{--tw-border-opacity:1;border-color:rgb(51 65 85 / var(--tw-border-opacity, 1))}.border-slate-800{--tw-border-opacity:1;border-color:rgb(30 41 59 / var(--tw-border-opacity, 1))}.border-slate-800\/50{border-color:rgb(30 41 59 / 0.5)}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0 / var(--tw-bg-opacity, 1))}.bg-black\/20{background-color:rgb(0 0 0 / 0.2)}.bg-black\/30{background-color:rgb(0 0 0 / 0.3)}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity, 1))}.bg-emerald-600{--tw-bg-opacity:1;background-color:rgb(5 150 105 / var(--tw-bg-opacity, 1))}.bg-red-600{--tw-bg-opacity:1;background-color:rgb(220 38 38 / var(--tw-bg-opacity, 1))}.bg-slate-700{--tw-bg-opacity:1;background-color:rgb(51 65 85 / var(--tw-bg-opacity, 1))}.bg-slate-800{--tw-bg-opacity:1;background-color:rgb(30 41 59 / var(--tw-bg-opacity, 1))}.bg-slate-900{--tw-bg-opacity:1;background-color:rgb(15 23 42 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.fill-slate-400{fill:#94a3b8}.p-4{padding:1rem}.p-2{padding:0.5rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-5{padding-top:1.25rem;padding-bottom:1.25rem}.pt-6{padding-top:1.5rem}.text-center{text-align:center}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-5xl{font-size:3rem;line-height:1}.text-\[10px\]{font-size:10px}.text-\[9px\]{font-size:9px}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.text-\[11px\]{font-size:11px}.font-black{font-weight:900}.font-bold{font-weight:700}.font-extrabold{font-weight:800}.uppercase{text-transform:uppercase}.italic{font-style:italic}.tracking-tighter{letter-spacing:-0.05em}.tracking-widest{letter-spacing:0.1em}.tracking-tight{letter-spacing:-0.025em}.text-black{--tw-text-opacity:1;color:rgb(0 0 0 / var(--tw-text-opacity, 1))}.text-blue-400{--tw-text-opacity:1;color:rgb(96 165 250 / var(--tw-text-opacity, 1))}.text-emerald-400{--tw-text-opacity:1;color:rgb(52 211 153 / var(--tw-text-opacity, 1))}.text-emerald-500{--tw-text-opacity:1;color:rgb(16 185 129 / var(--tw-text-opacity, 1))}.text-red-500{--tw-text-opacity:1;color:rgb(239 68 68 / var(--tw-text-opacity, 1))}.text-slate-300{--tw-text-opacity:1;color:rgb(203 213 225 / var(--tw-text-opacity, 1))}.text-slate-400{--tw-text-opacity:1;color:rgb(148 163 184 / var(--tw-text-opacity, 1))}.text-slate-500{--tw-text-opacity:1;color:rgb(100 116 139 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.underline{-webkit-text-decoration-line:underline;text-decoration-line:underline}.shadow-2xl{--tw-shadow:0 25px 50px -12px rgb(0 0 0 / 0.25);--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.outline-none{outline:2px solid transparent;outline-offset:2px}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-colors{transition-property:color, background-color, border-color, fill, stroke, -webkit-text-decoration-color;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, -webkit-text-decoration-color;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.hover\:bg-slate-700:hover{--tw-bg-opacity:1;background-color:rgb(51 65 85 / var(--tw-bg-opacity, 1))}.hover\:text-blue-400:hover{--tw-text-opacity:1;color:rgb(96 165 250 / var(--tw-text-opacity, 1))}.focus\:border-emerald-500:focus{--tw-border-opacity:1;border-color:rgb(16 185 129 / var(--tw-border-opacity, 1))}.active\:translate-y-1:active{--tw-translate-y:0.25rem;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.active\:scale-90:active{--tw-scale-x:.9;--tw-scale-y:.9;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.active\:border-b-0:active{border-bottom-width:0px}@media (min-width: 640px){.sm\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}}</style></head>
<body class="flex flex-col items-center p-4">


    <!-- Confirmation Modal -->
    <div id="confirmModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-slate-900 border-2 border-red-500 p-8 rounded-3xl max-w-sm w-full shadow-2xl text-center space-y-6">
            <h3 class="text-2xl font-black text-white">DISCONNECT?</h3>
            <p class="text-slate-300 font-bold">Are you sure you want to end the session and go back to home? This will close the connection.</p>
            <div class="flex gap-4">
                <button onclick="hideModal()" class="flex-1 bg-slate-700 py-3 rounded-xl font-black text-white">CANCEL</button>
                <button onclick="location.reload()" class="flex-1 bg-red-600 py-3 rounded-xl font-black text-white">EXIT</button>
            </div>
        </div>
    </div>

    <header class="w-full max-w-2xl p-4 flex justify-between items-center border-b border-slate-800 mb-4 shrink-0">
        <h1 class="text-3xl font-black text-emerald-500 italic tracking-tighter">SECURECHAT <span class="bg-slate-800 text-white text-xs px-2 py-1 rounded ml-1">BY POSSIBLE</span></h1>
        <div id="status"></div>
    </header>

    <main class="w-full max-w-xl flex-1 flex flex-col overflow-hidden">
        
        <!-- View 1: Selection -->
        <div id="viewSelection" class="space-y-8 mt-4 overflow-y-auto">
            <div class="text-center space-y-3">
                <h2 class="text-5xl font-extrabold text-white">Your personal web chatting app</h2>
                <p class="text-slate-300 font-bold">Encrypted P2P connection.</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <button onclick="initHost()" class="bg-emerald-600 p-8 rounded-3xl font-black text-xl border-b-4 border-emerald-900 active:translate-y-1 active:border-b-0 transition-all">CREATE ROOM</button>
                <button onclick="initJoin()" class="bg-white text-black p-8 rounded-3xl font-black text-xl border-b-4 border-slate-400 active:translate-y-1 active:border-b-0 transition-all">JOIN ROOM</button>

                <!-- Credit Section -->
                <div class="absolute-center-bottom">
                    
                    <div class="w-32 border-t border-slate-800/50 mb-4"></div>
                    
                    
                    <a href="https://github.com/Harshit-code07" target="_blank" class="credit-link flex items-center gap-2 text-slate-400 hover:text-blue-400 transition-colors group">
                        <svg class="w-6 h-6 fill-slate-400 transition-all" viewBox="0 0 24 24">
                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path>
                        </svg>
                        <span class="font-black tracking-widest text-sm uppercase">Harshit-code07</span>
                    </a>
                    
                    
<p class="text-[11px] font-black text-slate-300 uppercase tracking-tight mt-2">
    Made by Harshit with <span class="text-red-500">‚ù§</span>
</p>
                    
                </div>
                
            </div>
        </div>

        <!-- View 2: Handshake Area -->
        <div id="viewHandshake" class="hidden glass-box p-6 space-y-6 shadow-2xl relative overflow-y-auto max-h-full">
            <button onclick="location.reload()" class="absolute top-4 right-4 bg-slate-800 text-white text-[10px] font-black px-4 py-2 rounded-lg border border-slate-600 hover:bg-slate-700">GO HOME</button>
            
            <!-- HOST UI -->
            <div id="hostSection" class="hidden space-y-6 pt-6">
                <div class="space-y-2">
                    <label class="text-xs font-black text-emerald-400 uppercase ml-1">Your Name (This will be visible to your chat partner</label>
                    <input type="text" id="hostName" placeholder="Enter your username..." class="w-full bg-black border-2 border-slate-700 rounded-xl px-4 py-3 font-bold text-white outline-none">
                </div>

                <h3 class="text-xl font-black text-center text-emerald-400 uppercase mt-4">1. Share this QR or manual code with your partner</h3>
                <div class="flex justify-center"><div id="hostQrDisplay" class="qr-frame"></div></div>
                <button onclick="toggleText('hostOfferText')" class="w-full text-xs font-bold text-slate-400 underline">Show/Hide Manual Code</button>
                <textarea id="hostOfferText" readonly="" class="hidden w-full h-24 manual-code-area p-2 text-[10px] rounded outline-none"></textarea>
                
                <div class="h-px bg-slate-800 my-4"></div>
                
                <h3 class="text-xl font-black text-center text-blue-400 uppercase">2. Upload the response QR or paste the manual code shared by your partner</h3>
                <input type="file" id="hostScanFile" accept="image/*" class="hidden">
                <button onclick="document.getElementById('hostScanFile').click()" class="w-full bg-blue-600 py-4 rounded-xl font-black text-white">UPLOAD QR CODE</button>
                <textarea id="hostAnswerInput" placeholder="OR PASTE CODE HERE..." class="w-full h-20 manual-code-area p-2 text-xs rounded outline-none"></textarea>
                <button id="btnConnect" class="w-full bg-emerald-600 py-5 rounded-xl font-black text-xl border-b-4 border-emerald-900">Establish Connection</button>
            </div>

            <!-- JOINER UI -->
            <div id="joinSection" class="hidden space-y-6 pt-6">
                <div class="space-y-2">
                    <label class="text-xs font-black text-emerald-400 uppercase ml-1">Your Name (This will be visible to your chat partner) </label>
                    <input type="text" id="joinName" placeholder="Enter your username..." class="w-full bg-black border-2 border-slate-700 rounded-xl px-4 py-3 font-bold text-white outline-none">
                </div>

                <h3 class="text-xl font-black text-center text-emerald-400 uppercase mt-4">1. Upload QR or paste the manual code shared by the host</h3>
                <input type="file" id="joinScanFile" accept="image/*" class="hidden">
                <button onclick="document.getElementById('joinScanFile').click()" class="w-full bg-white text-black py-4 rounded-xl font-black">UPLOAD QR code</button>
                <textarea id="joinOfferInput" placeholder="OR PASTE INVITE CODE HERE..." class="w-full h-20 manual-code-area p-2 text-xs rounded outline-none"></textarea>
                
                <div class="h-px bg-slate-800 my-4"></div>
                
                <h3 class="text-xl font-black text-center text-blue-400 uppercase">2. Share this QR or manual code with the host and wait for the host to establish connection</h3>
                <div class="flex justify-center"><div id="joinQrDisplay" class="qr-frame"></div></div>
                <button onclick="toggleText('joinAnswerText')" class="w-full text-xs font-bold text-slate-400 underline">Show/Hide Manual Code</button>
                <textarea id="joinAnswerText" readonly="" class="hidden w-full h-24 manual-code-area p-2 text-[10px] rounded outline-none"></textarea>
            </div>
        </div>

        <!-- View 3: Chat Area -->
        <div id="viewChat" class="hidden flex-1 flex flex-col glass-box overflow-hidden shadow-2xl">
            <!-- Fixed Header -->
            <div class="p-4 bg-slate-800 flex justify-between items-center border-b border-slate-700 shrink-0">
                <div class="flex items-center gap-3">
                   <div class="flex flex-col">
                       <span id="partnerLabel" class="text-emerald-400 font-black text-sm uppercase tracking-widest">Chatting...</span>
                       <span class="text-[9px] text-slate-400 font-bold uppercase">YOUR MESSAGES ARE END TO END ECRYPTED</span>
                   </div>
                </div>
                <button onclick="showConfirm()" class="text-red-500 font-bold text-xs uppercase bg-black/30 px-3 py-2 rounded-lg">Exit</button>
            </div>
            
            <!-- Scrollable Messages -->
            <div id="chatBox" class="flex-1 p-6 chat-scroll-area space-y-4 flex flex-col bg-black/20"></div>
            
            <div class="p-4 bg-slate-900 border-t border-slate-800 flex gap-2 shrink-0">
                <input type="file" id="fileInput" class="hidden" multiple>
                <button id="fileBtn" class="bg-slate-700 px-4 rounded-xl font-black text-xs hover:bg-slate-600 transition-all">üìé</button>
                <input type="text" id="chatInput" placeholder="Type message..." class="flex-1 bg-black text-white border-2 border-slate-700 rounded-xl px-4 py-3 font-bold focus:border-emerald-500 outline-none">
                <button id="sendBtn" class="bg-emerald-600 px-6 rounded-xl font-black active:scale-90 transition-all shadow-lg">SEND</button>
            </div>
        </div>
    </main>

    <canvas id="tempCanvas" class="hidden"></canvas>

    <script>
        const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
        let dc = null;
        let myName = "User";
        let partnerName = "Partner";
        let fileChunks = new Map(); // For receiving files
        const CHUNK_SIZE = 16384; // 16KB chunks

        const toggleText = (id) => document.getElementById(id).classList.toggle('hidden');
        const showConfirm = () => document.getElementById('confirmModal').classList.remove('hidden');
        const hideModal = () => document.getElementById('confirmModal').classList.add('hidden');

        const setStatus = (txt) => {
            const s = document.getElementById('status');
            s.innerText = txt;
            if(txt === "CONNECTED") s.style.background = "#059669";
        };

        function makeQR(el, text) {
            el.innerHTML = "";
            new QRCode(el, {
                text: text,
                width: 280,
                height: 280,
                correctLevel: QRCode.CorrectLevel.L
            });
        }

        // --- HOST ---
        async function initHost() {
            document.getElementById('viewSelection').classList.add('hidden');
            document.getElementById('viewHandshake').classList.remove('hidden');
            document.getElementById('hostSection').classList.remove('hidden');
            dc = pc.createDataChannel("chat");
            setupDC();
            pc.onicecandidate = (e) => {
                if (!e.candidate) {
                    myName = document.getElementById('hostName').value || "Host";
                    const data = { sdp: pc.localDescription, name: myName };
                    const code = btoa(JSON.stringify(data));
                    document.getElementById('hostOfferText').value = code;
                    makeQR(document.getElementById("hostQrDisplay"), code);
                }
            };
            await pc.setLocalDescription(await pc.createOffer());
        }

        document.getElementById('btnConnect').onclick = async () => {
            const val = document.getElementById('hostAnswerInput').value.trim();
            if(!val) return;
            try { 
                const data = JSON.parse(atob(val));
                partnerName = data.name || "Partner";
                await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
                setStatus("CONNECTING...");
            } catch(e) { alert("Invalid QR/Code."); }
        };

        // --- JOINER ---
        async function initJoin() {
            document.getElementById('viewSelection').classList.add('hidden');
            document.getElementById('viewHandshake').classList.remove('hidden');
            document.getElementById('joinSection').classList.remove('hidden');
            pc.ondatachannel = (e) => { dc = e.channel; setupDC(); };
        }

        document.getElementById('joinOfferInput').oninput = async (e) => {
            const code = e.target.value.trim();
            if(!code) return;
            try {
                const data = JSON.parse(atob(code));
                partnerName = data.name || "Partner";
                await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
                await pc.setLocalDescription(await pc.createAnswer());
                pc.onicecandidate = (ev) => {
                    if (!ev.candidate) {
                        myName = document.getElementById('joinName').value || "Joiner";
                        const responseData = { sdp: pc.localDescription, name: myName };
                        const ans = btoa(JSON.stringify(responseData));
                        document.getElementById('joinAnswerText').value = ans;
                        makeQR(document.getElementById("joinQrDisplay"), ans);
                    }
                };
            } catch(err) {}
        };

        const scan = (fileId, inputId) => {
            document.getElementById(fileId).onchange = (e) => {
                const reader = new FileReader();
                reader.onload = (f) => {
                    const img = new Image();
                    img.onload = () => {
                        const cvs = document.getElementById('tempCanvas');
                        const ctx = cvs.getContext('2d');
                        cvs.width = img.width; cvs.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        const data = ctx.getImageData(0, 0, cvs.width, cvs.height);
                        const result = jsQR(data.data, data.width, data.height);
                        if(result) {
                            const inp = document.getElementById(inputId);
                            inp.value = result.data;
                            inp.dispatchEvent(new Event('input'));
                        } else { alert("Could not find QR."); }
                    };
                    img.src = f.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            };
        };
        scan('hostScanFile', 'hostAnswerInput');
        scan('joinScanFile', 'joinOfferInput');

        // --- CHAT ---
        function setupDC() {
            dc.onopen = () => {
                document.getElementById('viewHandshake').classList.add('hidden');
                document.getElementById('viewChat').classList.remove('hidden');
                document.getElementById('partnerLabel').innerText = partnerName;
                setStatus("CONNECTED");
                setTimeout(() => document.getElementById('chatInput').focus(), 500);
            };
            dc.onmessage = (e) => {
                handleFileMessage(e.data);
                try {
                    JSON.parse(e.data);
                } catch {
                    addMsg(e.data, 'them');
                }
            };
        }

        // File handling
        document.getElementById('fileBtn').onclick = () => {
            document.getElementById('fileInput').click();
        };

        document.getElementById('fileInput').onchange = async (e) => {
            const files = Array.from(e.target.files);
            for (const file of files) {
                await sendFile(file);
            }
            e.target.value = '';
        };

        async function sendFile(file) {
            if (!dc || dc.readyState !== 'open') {
                alert('Not connected!');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const arrayBuffer = e.target.result;
                const totalChunks = Math.ceil(arrayBuffer.byteLength / CHUNK_SIZE);
                const fileId = Date.now() + Math.random();

                const metadata = {
                    type: 'file-start',
                    fileId: fileId,
                    fileName: file.name,
                    fileSize: file.size,
                    fileType: file.type,
                    totalChunks: totalChunks
                };
                dc.send(JSON.stringify(metadata));

                for (let i = 0; i < totalChunks; i++) {
                    const start = i * CHUNK_SIZE;
                    const end = Math.min(start + CHUNK_SIZE, arrayBuffer.byteLength);
                    const chunk = arrayBuffer.slice(start, end);
                    
                    const chunkData = {
                        type: 'file-chunk',
                        fileId: fileId,
                        chunkIndex: i,
                        data: btoa(String.fromCharCode(...new Uint8Array(chunk)))
                    };
                    dc.send(JSON.stringify(chunkData));
                    await new Promise(resolve => setTimeout(resolve, 10));
                }

                const complete = { type: 'file-complete', fileId: fileId };
                dc.send(JSON.stringify(complete));

                addFileMessage(file.name, file.size, 'me');
            };
            reader.readAsArrayBuffer(file);
        }

        function handleFileMessage(data) {
            try {
                const msg = JSON.parse(data);
                
                if (msg.type === 'file-start') {
                    fileChunks.set(msg.fileId, {
                        fileName: msg.fileName,
                        fileSize: msg.fileSize,
                        fileType: msg.fileType,
                        totalChunks: msg.totalChunks,
                        chunks: [],
                        receivedChunks: 0
                    });
                } else if (msg.type === 'file-chunk') {
                    const fileInfo = fileChunks.get(msg.fileId);
                    if (fileInfo) {
                        fileInfo.chunks[msg.chunkIndex] = msg.data;
                        fileInfo.receivedChunks++;
                    }
                } else if (msg.type === 'file-complete') {
                    const fileInfo = fileChunks.get(msg.fileId);
                    if (fileInfo && fileInfo.receivedChunks === fileInfo.totalChunks) {
                        const binaryString = fileInfo.chunks.map(c => atob(c)).join('');
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        const blob = new Blob([bytes], { type: fileInfo.fileType });
                        
                        addFileMessage(fileInfo.fileName, fileInfo.fileSize, 'them', blob);
                        fileChunks.delete(msg.fileId);
                    }
                }
            } catch (e) {
                
            }
        }

        function addFileMessage(fileName, fileSize, sender, blob = null) {
            const box = document.getElementById('chatBox');
            const d = document.createElement('div');
            d.className = `msg-file ${sender === 'me' ? 'msg-me' : 'msg-them'}`;
            
            const sizeStr = fileSize < 1024 ? `${fileSize} B` : 
                           fileSize < 1024*1024 ? `${(fileSize/1024).toFixed(2)} KB` :
                           `${(fileSize/(1024*1024)).toFixed(2)} MB`;
            
            d.innerHTML = `
                <div class="font-bold">üìé ${fileName}</div>
                <div class="text-sm opacity-80">${sizeStr}</div>
                ${blob ? '<div class="text-sm mt-2">Click to download</div>' : ''}
            `;
            
            if (blob) {
                d.onclick = () => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.click();
                    URL.revokeObjectURL(url);
                };
            }
            
            box.appendChild(d);
            box.scrollTop = box.scrollHeight;
        }

        function addMsg(text, type) {
            const box = document.getElementById('chatBox');
            const d = document.createElement('div');
            d.className = `p-4 max-w-[85%] font-bold shadow-lg ${type === 'me' ? 'msg-me' : 'msg-them'}`;
            d.innerText = text;
            box.appendChild(d);
            box.scrollTop = box.scrollHeight;
        }

        const doSend = () => {
            const i = document.getElementById('chatInput');
            if(i.value && dc?.readyState === 'open') {
                dc.send(i.value);
                addMsg(i.value, 'me');
                i.value = "";
                i.focus();
            }
        };
        document.getElementById('sendBtn').onclick = doSend;
        document.getElementById('chatInput').onkeydown = (e) => {
            if(e.key === "Enter") {
                e.preventDefault();
                doSend();
            }
        };
    </script>

</body></html>
